name: CD - ECS Blue Green Deployment

on:
  workflow_run:
    workflows: ["CI - Build & Push Strapi Image"]
    types: [completed]

  workflow_dispatch:

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-southeast-1
      ECS_CLUSTER: strapi-cluster
      ECS_SERVICE: strapi-service
      CONTAINER_NAME: strapi
      CONTAINER_PORT: 1337
      CODEDEPLOY_APPLICATION: strapi-bg-codedeploy-app
      CODEDEPLOY_DEPLOYMENT_GROUP: strapi-bg-dg

    steps:
      # -------------------------------
      # Checkout Repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # Configure AWS Credentials
      # -------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -------------------------------
      # ðŸ”¥ INSTALL TERRAFORM (FIX)
      # -------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      # -------------------------------
      # Terraform Init
      # -------------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # -------------------------------
      # Terraform Apply (AUTO CREATE EVERYTHING)
      # -------------------------------
      - name: Terraform Apply
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="image_url=${{ secrets.ECR_REPO }}:${{ github.sha }}" \
            -var="db_name=${{ secrets.DB_NAME }}" \
            -var="db_user=${{ secrets.DB_USER }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}"

      # -------------------------------
      # Create AppSpec
      # -------------------------------
      - name: Create AppSpec
        run: |
          cat > appspec.json << EOF
          {
            "version": 1,
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "$(aws ecs describe-services \
                      --cluster $ECS_CLUSTER \
                      --services $ECS_SERVICE \
                      --query 'services[0].taskDefinition' \
                      --output text)",
                    "LoadBalancerInfo": {
                      "ContainerName": "$CONTAINER_NAME",
                      "ContainerPort": $CONTAINER_PORT
                    }
                  }
                }
              }
            ]
          }
          EOF

      # -------------------------------
      # Trigger CodeDeploy Blue-Green
      # -------------------------------
      - name: Deploy via CodeDeploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
          --application-name $CODEDEPLOY_APPLICATION \
          --deployment-group-name $CODEDEPLOY_DEPLOYMENT_GROUP \
          --revision "revisionType=AppSpecContent,appSpecContent={content=$(sed 's/\"/\\\"/g' appspec.yml)}" \
          --description "GitHub Actions ECS Blue-Green Deployment" \
          --query "deploymentId" \
          --output text)
          echo "ðŸš€ Deployment ID: $DEPLOYMENT_ID"






      # - name: Deploy via CodeDeploy
      #   run: |
      #     aws deploy create-deployment \
      #       --application-name $CODEDEPLOY_APPLICATION \
      #       --deployment-group-name $CODEDEPLOY_DEPLOYMENT_GROUP \
      #       --revision "revisionType=AppSpecContent,appSpecContent={content=file://appspec.json}" \
      #       --description "GitHub Actions ECS Blue-Green Deployment"









# name: CD - ECS Blue Green Deployment

# on:
#   # Automatic trigger after CI success
#   workflow_run:
#     workflows: ["CI - Build & Push Strapi Image"]
#     types:
#       - completed

#   # Manual trigger
#   workflow_dispatch:

# jobs:
#   deploy:
#     # Prevent CD from running if CI failed
#     if: |
#       github.event_name == 'workflow_dispatch' ||
#       github.event.workflow_run.conclusion == 'success'

#     runs-on: ubuntu-latest

#     env:
#       AWS_REGION: ap-southeast-1
#       ECS_CLUSTER: strapi-cluster
#       ECS_SERVICE: strapi-service
#       CONTAINER_NAME: strapi
#       CONTAINER_PORT: 1337
#       CODEDEPLOY_APPLICATION: strapi-bg-codedeploy-app
#       CODEDEPLOY_DEPLOYMENT_GROUP: strapi-bg-dg

#     steps:
#       # -------------------------------
#       # Checkout Repo
#       # -------------------------------
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # -------------------------------
#       # Configure AWS Credentials
#       # -------------------------------
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       # -------------------------------
#       # Get Current Task Definition
#       # -------------------------------
#       - name: Get current task definition
#         run: |
#           aws ecs describe-services \
#             --cluster $ECS_CLUSTER \
#             --services $ECS_SERVICE \
#             --query "services[0].taskDefinition" \
#             --output text

#       # -------------------------------
#       # Register New Task Definition
#       # -------------------------------
#       - name: Register new task definition
#         id: task-def
#         run: |
#           NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
#             --cli-input-json file://terraform/task-def.json \
#             --query "taskDefinition.taskDefinitionArn" \
#             --output text)

#           echo "task_def_arn=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT

#       # -------------------------------
#       # Create AppSpec JSON
#       # -------------------------------
#       - name: Create AppSpec
#         run: |
#           cat > appspec.json << EOF
#           {
#             "version": 0.0,
#             "Resources": [
#               {
#                 "TargetService": {
#                   "Type": "AWS::ECS::Service",
#                   "Properties": {
#                     "TaskDefinition": "${{ steps.task-def.outputs.task_def_arn }}",
#                     "LoadBalancerInfo": {
#                       "ContainerName": "${CONTAINER_NAME}",
#                       "ContainerPort": ${CONTAINER_PORT}
#                     }
#                   }
#                 }
#               }
#             ]
#           }
#           EOF

#       # -------------------------------
#       # Trigger CodeDeploy Deployment
#       # -------------------------------
#       - name: Deploy via CodeDeploy
#         id: deploy
#         run: |
#           DEPLOYMENT_ID=$(aws deploy create-deployment \
#             --application-name $CODEDEPLOY_APPLICATION \
#             --deployment-group-name $CODEDEPLOY_DEPLOYMENT_GROUP \
#             --revision "revisionType=AppSpecContent,appSpecContent={content=file://appspec.json}" \
#             --description "GitHub Actions ECS Blue-Green Deployment" \
#             --query "deploymentId" \
#             --output text)

#           echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
#           echo "ðŸš€ Deployment ID: $DEPLOYMENT_ID"

#       # -------------------------------
#       # Deployment Summary
#       # -------------------------------
#       - name: Deployment Summary
#         run: |
#           echo "## ðŸš€ ECS Blue-Green Deployment Started" >> $GITHUB_STEP_SUMMARY
#           echo "- Deployment ID: ${{ steps.deploy.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Cluster: $ECS_CLUSTER" >> $GITHUB_STEP_SUMMARY
#           echo "- Service: $ECS_SERVICE" >> $GITHUB_STEP_SUMMARY
#           echo "- Region: $AWS_REGION" >> $GITHUB_STEP_SUMMARY








# name: CD â€“ Deploy Strapi to ECS

# on:
#   workflow_run:
#     workflows: ["CI â€“ Build & Push Strapi Image"]
#     types: [completed]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Configure AWS
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ap-southeast-1

#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3

#       - name: Terraform Init
#         working-directory: terraform
#         run: terraform init

#       - name: Terraform Apply
#         working-directory: terraform
#         run: |
#           terraform apply -auto-approve \
#             -var="image_url=${{ secrets.ECR_REPO }}:${{ github.sha }}" \
#             -var="db_name=${{ secrets.DB_NAME }}" \
#             -var="db_user=${{ secrets.DB_USER }}" \
#             -var="db_password=${{ secrets.DB_PASSWORD }}"

#         # ðŸ”¥ THIS IS THE MISSING STEP ðŸ”¥
#       - name: Trigger CodeDeploy Blue-Green Deployment
#         run: |
#           TASK_DEF=$(aws ecs list-task-definitions \
#             --family-prefix strapi-bg-task \
#             --sort DESC \
#             --query 'taskDefinitionArns[0]' \
#             --output text)

#           aws deploy create-deployment \
#             --application-name strapi-bg-codedeploy-app \
#             --deployment-group-name strapi-bg-dg \
#             --revision "revisionType=AppSpecContent,appSpecContent={content=$(sed 's/\"/\\\"/g' appspec.yml)}" \
#             --region ap-southeast-1    
  



# name: CD - Terraform Deploy (ECS Blue Green)

# on:
#   workflow_run:
#     workflows: ["CI - Build & Push Strapi Image"]
#     types:
#       - completed

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # ----------------------------------
#       # Checkout repository
#       # ----------------------------------
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # ----------------------------------
#       # Configure AWS credentials
#       # ----------------------------------
#       - name: Configure AWS
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ap-southeast-1

#       # ----------------------------------
#       # Setup Terraform
#       # ----------------------------------
#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3

#       # ----------------------------------
#       # Terraform Init
#       # ----------------------------------
#       - name: Terraform Init
#         working-directory: terraform
#         run: terraform init

#       # ----------------------------------
#       # Terraform Apply
#       # ----------------------------------
#       - name: Terraform Apply
#         working-directory: terraform
#         run: |
#           terraform apply -auto-approve \
#             -var="image_url=${{ secrets.ECR_REPO }}:latest" \
#             -var="db_name=${{ secrets.DB_NAME }}" \
#             -var="db_user=${{ secrets.DB_USER }}" \
#             -var="db_password=${{ secrets.DB_PASSWORD }}"


